{"title":"First NPAG run","markdown":{"headingText":"First NPAG run","containsRefs":false,"markdown":"\nYou must always load the Pmetrics library first.\n\n```{r}\n#| eval: true\n#| output: false\n#library(Pmetrics)\ndevtools::load_all()\n```\n\n\n### Working directory\n\nYou must always tell R where your working directory is going to be. This is the directory where R expects to find files and where it will save output files. You can set your working directory with the `setwd()` function.\n\nWindows users: Make sure that you separate directories with a forward slash \"/\" or double backslashes \"\\\\\". Unfortunately, Windows is the only OS that uses backslashes \"\", so R conforms to Unix/Linux style with the forward slash. If you copy the example below, make sure to change the path to one that exists on your computer.\n\n```{r}\n# change the path to one that exists on your computer\nsetwd(\"/path/to/your/project/directory\") # Mac and Linux users\nsetwd(\"C:/path/to/your/project/directory\") # Windows users\n```\n\n### Data objects\n\nPmetrics always needs data and a model to run, so let's create a new data object. We will set the limit of quantification (loq) to 1. See ?PM_data for help.\n\n```{r}\n#| eval: true\nexData <- PM_data$new(data = \"../Examples/src/ex.csv\", loq = 1)\n```\n\nHere we did execute the code so you can see the output. Pmetrics standardizes the data, checks for errors, and provides an error and attempted fix report fo any found.\n\nYou can look at a .csv data file directly by opening it in a spreadsheet program like Excel, or a text editor.\n\n`exData` is an R6 object, which means that contains both data and methods to process that data.\n\n```{r}\nexData # prints the object, usually to the terminal, but in this case to a rendered \"lite\" spreadsheet\nexData$data # contains your original data\nexData$standard_data # contains the standardized and validated data\nexData$summary() # prints the summary of the data to the terminal\n```\n\nMost Pmetrics objects are R6 objects, so you can use the `$` operator to access their data and methods. Many of them have a `summary()` method that prints a summary of the object to the console and a `plot()` method that creates a plot of the object. See `?PM_data` for more information on the `PM_data` class and its methods.\n\n**Note:** We recognize that many users are familiar with the \"S3 framework\" in R, which uses functions like `summary(object)` and `plot(object)`. To comply with better programming standards, Pmetrics uses the R6 framework. However, we have provided S3 methods for most functions, so you can use `summary(object)` and `plot(object)` if you prefer.\n\n```{r}\n# S3 method to summarize data\nsummary(exData)\n```\n\n`PM_data` has a `plot()` method that creates a plot of the data. See `?plot.PM_data` for more information.\n\n```{r}\n#| eval: true\n# piping to plotlygg() turns the interractive plotly plot to a static ggplot2 plot \nexData$plot() %>% plotlygg()\n```\n\nWe have piped (`%>%`) the plot to `plotlygg()` to convert the interactive plotly plot to a static ggplot2 plot for rendering in this document. You can interact with the plot in your own script or Quarto document. If you're not familiar with the pipe operator, see [this article](https://magrittr.tidyverse.org/). We strongly recommend Tidvyerse for data manipulation and visualization in R, and Pmetrics works well with it. See [R for Data Science](https://r4ds.hadley.nz) for more information.\n\n### Model objects\n\nYou can specify a model by reading a file or directly as a list object in R. We'll do both.\n\nThe following code creates the same model as in `/src/model.txt` file. See further [model details](https://lapkb.github.io/Pmetrics/articles/models.html) on creating models in R compared to text files. The advantage of creating them in R is that one does not need to copy model files into folders to provide necessary inputs.\n\n```{r}\n#| label: mod1_def\n#| eval: true\nmod1 <- PM_model$new(\n  pri = list(\n    Ka = ab(0.1, 0.9),\n    Ke = ab(0.001, 0.1),\n    V = ab(30, 120),\n    lag1 = ab(0, 4)\n  ),\n  cov = list(\n    wt = interp(),\n    africa = interp(\"none\"),\n    age = interp(),\n    gender = interp(\"none\"),\n    height = interp()\n  ),\n  eqn = function(){\n    two_comp_bolus\n  },\n  lag = function(){\n    lag[1] = lag1\n  },\n  out = function(){\n  Y[1] = X[2]/V\n  },\n  err = list(\n    proportional(5, c(0.02, 0.05, -0.0002, 0))\n  )\n)\n```\n\nWhen you execute the above code in your own script or Quarto document, you will see a message indicating that the model has compiled.\n\n```{r}\n#| eval: true\nmod1 # prints the model object\n```\n\n```{r}\n#| eval: true\n#| message: false\n\nmod1$plot() # static plot so do not need to pipe to plotlygg() \n```\n\nWe have another file \"model.txt\" that contains the old representation of the same model we coded above, let's take a look at it.\n\n```{r}\nsystem(\"cat ../Examples/src/model.txt\")\n```\n\nYou can also open it in a text editor.\n\n`PM_model$new()` also accepts the path to a model file to create the same model using the file.\n\n```{r}\nmod1b <- PM_model$new(\"../Examples/src/model.txt\")\nmod1b # look at it\n```\n\nPM_model provides a method to update the different elements of a model, for example:\n\n```{r}\nmod1b$update(\n  pri = list(\n    ka = ab(0.001, 5)\n))\n```\n\nIt is case sensitive, so ka is different from Ka. To remove a parameter, set it to NULL.\n\nTo copy a model use the \\$clone() method.\n\n```{r}\nmod1b <- mod1$clone()\n```\n\nSimply using `mod1b <- mod1` will cause `mod1b` to be changed if `mod1` is changed, as R6 objects use reference semantics. For more details you can refer to \\[Advanced R\\] (https://adv-r.hadley.nz/r6.html), Section 14.4.\n\nLastly, Pmetrics has a model building app!\n\n```{r}\nbuild_model() #start from scratch\nbuild_model(exData) #start with data to match covariates\nbuild_model(mod1) #start with a model and update it\n```\n\n### Fit the model to the data\n\nTo keep everything tidy, we are working in a folder specifically to store the runs.\n\n```{r}\n#| label: change_Runs\n#| eval: true\n#| echo: false\nwd <- getwd() # save the current working directory\nknitr::opts_knit$set(root.dir = \"../Examples/Runs\") # change to the runs directory\n```\n```{r}\n#| eval: true\nrun1 <- mod1$fit(data = exData, run = 1, overwrite = TRUE, report = \"none\") \n```\n\n**Note:** We suppressed the report in this tutorial, but if you copy the code into your own script, you can see the html summary report that is generated at the end of a run by removing the `report = \"none\"` argument.\n\nAfter the run is complete the results are returned to the assigned object, here 'run1'. However, if you want to load the results later, you can use the `PM_load()` function. Runs will be sequentially numbered as /1, /2, /3,... in your working directory.\n\n```{r}\nrun1 <- PM_load(1) # load the results from run 1 if returning to this script later\n```\n\n```{r}\n#| eval: true\n#| echo: false\nknitr::opts_knit$set(root.dir = wd) # return to the original working directory\n```\n### Examine the results\n\n#### Data\n\nYou can plot the original data using R6 with various options. Type ?plot.PM_data in the R console for help.\n\n```{r}\n#| eval: true\nrun1$data$plot() %>% plotlygg() \n```\n\nRemove the `%>% plotlygg()` portion in your own script or Quarto document to generate an interactive plot. Mouse over the points to get information. Try clicking one of the points to see what happens.\n\nHere's some nice grouping and coloring. If you use grouping, provide names in `group_names` and colors/symbols for each group as arguments to `marker`. Colors of lines will be set to the same as for `marker` to avoid a mess of colors.\n\n```{r}\n#| eval: true\nrun1$data$plot(xlim = c(119, 146), group = \"gender\", group_names = c(\"Male\", \"Female\"), \n  marker = list(color = c(\"red\",\"blue\"), symbol = c(\"circle\",\"triangle-up\"))) %>% plotlygg()\n```\n\nThe next one splits the data by subject but will not render easily in this document. You can interact with it in your own script or Quarto document.\n\n```{r}\nrun1$data$plot(overlay = FALSE, xlim = c(119, 145))\n```\n\nThe following are the older S3 method with `plot(...)` for the first two examples. You can use R6 or S3 for any Pmetrics object. We will focus on R6 as the more modern way.\n\n```{r}\nplot(run1$data)\n```\n\nHere's a summary of the original data file; `?summary.PM_data` for help.\n\n```{r}\nrun1$data$summary()\n```\n\n#### Observed vs. Predicted (OP)\n\nYou can plot observed vs. predicted data. Type `?plot.PMop` in the R console for help.\n\n```{r}\n#| eval: true\nrun1$op$plot() %>% plotlygg()\n```\n\nAs always, remove the `%>% plotlygg()` portion in your own script or Quarto document to generate an interactive plot. Below, you can see how to change the prediction type, regression line and color, and plotting symbol and color. Most plots in Pmetrics have `marker` and `line` list arguments to customize the appearance of the plotting symbols and lines.\n\n```{r}\nrun1$op$plot(pred.type = \"pop\")\nrun1$op$plot(line = list(lm = FALSE, loess = list(color = \"red\")), marker = list(symbol = 3, color = \"green\"))\n```\n\nGet a summary with bias and imprecision of the population predictions; `?summary.PMop` for help. The default `pred.type` is \"post\", which are the predictions based on the full Bayesian posterior distribution of parameter values for an individual. The predictions are the weighted mean or median (controlled by the `icen` argument in all Pmetrics functions) of the predictions from each support point in the individual's Bayesian posterior, joint probability parameter distribution, i.e. the support points in the posterior. Here we will look at the population predictions based on the means of the parameter values.\n\n```{r}\nrun1$op$summary(pred.type = \"pop\", icen = \"mean\")\n```\n\nSince neither \"pop\" nor \"mean\" are the defaults, we have to specify them. We can also use the S3 method for the same summary below.\n\n```{r}\nsummary(run1$op, pred.type = \"pop\", icen = \"mean\") # S3 method\n```\n\nAs with any object in Pmetrics, the `PM_op` R6 object has fields and methods. Fields contain data and methods are functions that act on the data. All fields and methods are accessed with `$` added to the name of the object. For example, in a `PM_op` object and most other Pmetrics objects, the raw data can be accessed via the `$data` field.\n\n```{r}\nrun1$op$data\n```\n\nHaving the raw data provides a data frame compatible with any R function, particularly those from **Tidyverse** (see https://www.tidyverse.org/), including piping.\n\nThis allows pre-processing in ways more flexible than the default plot method.\n\n```{r}\nlibrary(tidyverse)\nrun1$op$data %>% plot()\nrun1$op$data %>%\n  filter(pred > 5) %>%\n  filter(pred < 10) %>%\n  summary()\n```\n\nSee a header with the first 10 rows of the op object:\n\n```{r}\nhead(run1$op$data, 10)\n```\n\n#### Final population joint density\n\nPlot the final population joint density. Type `?plot.PM_final` in the R console for help.\n\n```{r}\nrun1$final$plot()\n```\n\nYou can add a kernel density curve.\n\n```{r}\nrun1$final$plot(line = list((color = \"red\")))\n#run1$final$data %>% plot() #this way will work too\n```\n\nIt is possible to make a bivariate plot. Plotting formulae in R are of the form `y~x`\n\n```{r}\nrun1$final$plot(ke ~ v,\n  marker = list(color = \"red\", symbol = \"diamond\"))\n```\n\nThe original final object can be accessed with the `$data` field.\n\n```{r}\nrun1$final$data\nnames(run1$final$data)\n```\n\nSee the population points:\n\n```{r}\n#| eval: true\nrun1$final$popPoints\n```\n\nOr drill down one more level into the raw data. The `$final$popPoints` field above pulls its information from the `$final$data$popPoints` field below, but is provided as a simpler way to access the population points.\n\n```{r}\nrun1$final$data$popPoints\n```\n\nSee the population mean parameter values:\n\n```{r}\n#| eval: true\nrun1$final$popMean\n```\n\nSee a summary with confidence intervals around the medians and the Median Absolute Weighted Difference (MAWD); `?summary.PM_final` for help and further explanation.\n\n```{r}\nrun1$final$summary()\n```\n\n#### Cycle information\n\nPlot cycle information; type `?plot.PM_cycle` in the R console for help.\n\n```{r}\nrun1$cycle$plot()\n```\n\nSummarize the cycle information; `?summary.PM_cycle` for help.\n\n```{r}\nrun1$cycle$summary()\nrun1$cycle$data %>% summary()\n```\n\nEither one will work.\n\n#### Covariate information\n\nPlot covariate information; type `?plot.PM_cov` in the R console for help. Recall that plotting formulae in R are of the form `y~x`.\n\n```{r}\nrun1$cov$plot(v ~ wt)\n```\n\nYou can also use the raw data in the `$data` field to make plots with other R functions, including those from **Tidyverse**. Here we will filter the data for age \\> 25 and then plot volume vs. weight.\n\n```{r}\nrun1$cov$data %>%\n  filter(age > 25) %>%\n  plot(v ~ wt)\n```\n\nChange the formatting of the plot with the `line` and `marker` list arguments.\n\n```{r}\nrun1$cov$plot(ke ~ age, line = list(loess = FALSE, lm = list(color = \"red\")),\n               marker = list(symbol = 3))\n```\n\nAnother plot with mean Bayesian posterior parameter and covariate values...remember the `icen` argument?\n\n```{r}\nrun1$cov$plot(v ~ wt, icen = \"mean\")\n```\n\nWhen `time` is the `x` variable, the `y` variable is aggregated by subject. In R plot formulae, calculations on the fly can be included using the `I()` function.\n\n```{r}\nrun1$cov$plot(I(v * wt) ~ time)\n```\n\nThe above plots the product of volume and weight vs. time for each subject.\n\nThe previous cov object can be seen via `run1$cov`, which looks like a data frame, but is really an R6 `PM_cov` object whose `$print()` method returns a data frame. You can access the raw data with the `$data` field, which is truly a data frame.\n\n```{r}\nrun1$cov$data[, 1:3] # for example\nrun1$cov$data %>% filter(gender == 1) %>% summary() # using Tidyverse\n```\n\nJust as you have the option to plot by mean covariate and posterior parameter values, you can summarize with means; `?summary.PM_cov` for help.\n\n```{r}\nrun1$cov$summary(icen = \"mean\")\n```\n\nThis returns a data frame with the means of the individual's covariates over the observation period and the mean of the Bayesian posterior parameter values.\n\nWhen trying to find covariate-parameter relationships, it is convenient to examine at all possible covariate-parameter relationships by multiple linear regression with forward and backward elimination - type `?PM_step` in the R console for help.\n\n```{r}\nrun1$step()\n```\n\n...or on the cov object directly.\n\n```{r}\nrun1$cov$step()\n```\n\n`icen` works here too.\n\n```{r}\nrun1$step(icen = \"mean\")\n```\n\nIf you wish to see P values for forward elimination only:\n\n```{r}\nrun1$step(direction = \"forward\")\n```","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":false,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":true,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"toc":true,"include-in-header":["copy-all-code.html"],"output-file":"NPAG.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.5.56","pdf":{"documentclass":"scrreprt"},"theme":"cosmo"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}